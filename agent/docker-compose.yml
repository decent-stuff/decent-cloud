services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test
    networks:
      - decent-cloud-network

  agent:
    build:
      context: ..
      dockerfile: agent/Dockerfile
    image: decent-cloud-agent:latest
    depends_on:
      - postgres
    # Run with docker group to access the socket
    group_add:
      - ${DOCKER_GID:-999}
    user: "0:0" # Start as root to fix volume permissions
    entrypoint: ["/tini", "--", "/home/ubuntu/entrypoint.sh"]
    environment:
      # Development environment variables
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      - HOME=/home/ubuntu
      - VIRTUAL_ENV=/home/ubuntu/.venv
      # PostgreSQL connection for testing
      - DATABASE_URL_PG=postgres://test:test@postgres:5432/test
    volumes:
      # Mount the entire repository directory to /code
      - ..:/code
      # Use container-local target/ dir to avoid conflicts between concurrent agents
      # Volume name includes project name (-p flag) so each agent gets its own
      - target-cache:/code/target
      # Mount some other configuration from home directory
      - ${HOME}/.claude.json:/home/ubuntu/.claude.json
      - ${HOME}/.claude:/home/ubuntu/.claude
      - ${HOME}/.happy:/home/ubuntu/.happy
      - ${HOME}/.opencode:/home/ubuntu/.opencode
      # Cache volumes for rust tooling and dependencies (controlled by ubuntu user)
      - rustup-cache:/usr/local/rustup
      - cargo-cache:/home/ubuntu/.cargo
      - home-cache:/home/ubuntu/.cache
      # SSH key for agent access to remote nodes
      - ${HOME}/.ssh/claude-code:/tmp/claude-ssh/claude-code:ro
      - ${HOME}/.ssh/claude-code.pub:/tmp/claude-ssh/claude-code.pub:ro
      # Docker socket for running docker commands inside the container
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /code
    stdin_open: true
    tty: true
    ports:
      # Expose website port if needed
      - "59010:59010"
      - "59011:59011"
    networks:
      - decent-cloud-network

volumes:
  rustup-cache:
    driver: local
  cargo-cache:
    driver: local
  home-cache:
    driver: local
  target-cache:
    driver: local

networks:
  decent-cloud-network:
    driver: bridge

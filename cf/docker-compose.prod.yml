# Production environment - standalone
# Deploy: python3 cf/deploy.py deploy prod
# Manual: docker compose -f cf/docker-compose.prod.yml up -d
# URLs: decent-cloud.org, api.decent-cloud.org, support.decent-cloud.org

services:
  # ============================================
  # Chatwoot - Customer Support Platform
  # ============================================
  chatwoot-redis:
    image: redis:8-alpine
    container_name: decent-cloud-prod-chatwoot-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - decent-cloud-prod-chatwoot-redis:/data
    networks:
      - decent-cloud-prod
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  chatwoot-web:
    image: chatwoot/chatwoot:v4.8.0
    container_name: decent-cloud-prod-chatwoot-web
    restart: unless-stopped
    depends_on:
      chatwoot-redis:
        condition: service_healthy
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
      POSTGRES_HOST: 192.168.0.2
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: chatwoot_prod
      POSTGRES_USERNAME: chatwoot_prod
      POSTGRES_PASSWORD: ${CHATWOOT_POSTGRES_PASSWORD}
      REDIS_URL: redis://chatwoot-redis:6379
      FRONTEND_URL: ${CHATWOOT_FRONTEND_URL:-https://support.decent-cloud.org}
      # HMAC for customer identity validation (must match API)
      CHATWOOT_INBOX_HMAC_SECRET_KEY: ${CHATWOOT_HMAC_SECRET}
      # Email notifications
      MAILER_SENDER_EMAIL: ${CHATWOOT_MAILER_SENDER:-support@decent-cloud.org}
      SMTP_ADDRESS: ${SMTP_ADDRESS}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_AUTHENTICATION: plain
      SMTP_ENABLE_STARTTLS_AUTO: "true"
      # Optional AI features
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Disable telemetry
      DISABLE_TELEMETRY: "true"
    command: bundle exec rails s -p 59102 -b '0.0.0.0'
    ports:
      - "59102:59102"
    networks:
      - decent-cloud-prod
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://127.0.0.1:59102/api >/dev/null 2>&1 || exit 1",
        ]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  chatwoot-worker:
    image: chatwoot/chatwoot:v4.8.0
    container_name: decent-cloud-prod-chatwoot-worker
    restart: unless-stopped
    depends_on:
      chatwoot-redis:
        condition: service_healthy
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
      POSTGRES_HOST: 192.168.0.2
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: chatwoot_prod
      POSTGRES_USERNAME: chatwoot_prod
      POSTGRES_PASSWORD: ${CHATWOOT_POSTGRES_PASSWORD}
      REDIS_URL: redis://chatwoot-redis:6379
      FRONTEND_URL: ${CHATWOOT_FRONTEND_URL:-https://support.decent-cloud.org}
      CHATWOOT_INBOX_HMAC_SECRET_KEY: ${CHATWOOT_HMAC_SECRET}
      MAILER_SENDER_EMAIL: ${CHATWOOT_MAILER_SENDER:-support@decent-cloud.org}
      SMTP_ADDRESS: ${SMTP_ADDRESS}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
    command: bundle exec sidekiq -C config/sidekiq.yml
    networks:
      - decent-cloud-prod

  # Run database migrations on startup (one-time)
  chatwoot-migrate:
    image: chatwoot/chatwoot:v4.8.0
    container_name: decent-cloud-prod-chatwoot-migrate
    depends_on:
      chatwoot-redis:
        condition: service_healthy
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
      POSTGRES_HOST: 192.168.0.2
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: chatwoot_prod
      POSTGRES_USERNAME: chatwoot_prod
      POSTGRES_PASSWORD: ${CHATWOOT_POSTGRES_PASSWORD}
      REDIS_URL: redis://chatwoot-redis:6379
    command: bundle exec rails db:chatwoot_prepare
    networks:
      - decent-cloud-prod

  # Link platform app to account (idempotent, runs on every deploy)
  chatwoot-setup:
    image: chatwoot/chatwoot:v4.8.0
    container_name: decent-cloud-prod-chatwoot-setup
    depends_on:
      chatwoot-migrate:
        condition: service_completed_successfully
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}
      POSTGRES_HOST: 192.168.0.2
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: chatwoot_prod
      POSTGRES_USERNAME: chatwoot_prod
      POSTGRES_PASSWORD: ${CHATWOOT_POSTGRES_PASSWORD}
      REDIS_URL: redis://chatwoot-redis:6379
      CHATWOOT_ACCOUNT_ID: ${CHATWOOT_ACCOUNT_ID:-1}
    command: >
      bundle exec rails runner "
        account_id = ENV['CHATWOOT_ACCOUNT_ID'].to_i
        account = Account.find_by(id: account_id)
        exit 0 unless account
        PlatformApp.find_each do |app|
          app.platform_app_permissibles.find_or_create_by!(permissible: account)
          puts \"Linked PlatformApp '#{app.name}' to Account #{account_id}\"
        end
      "
    networks:
      - decent-cloud-prod

  # ============================================
  # Application Services
  # ============================================

  # Configuration doctor - runs on deploy to check setup
  api-doctor:
    image: decent-cloud-api:prod
    container_name: decent-cloud-prod-api-doctor
    depends_on:
      chatwoot-setup:
        condition: service_completed_successfully
    command: ["api-server", "doctor"]
    environment:
      - DATABASE_URL=sqlite:/data/ledger.db?mode=rwc
      # Chatwoot integration
      - CHATWOOT_BASE_URL=http://chatwoot-web:59102
      - CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
      - CHATWOOT_PLATFORM_API_TOKEN=${CHATWOOT_PLATFORM_API_TOKEN}
      - CHATWOOT_ACCOUNT_ID=${CHATWOOT_ACCOUNT_ID:-1}
      - CHATWOOT_HMAC_SECRET=${CHATWOOT_HMAC_SECRET}
      # Notifications
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TEXTBEE_DEVICE_ID=${TEXTBEE_DEVICE_ID:-}
      - TEXTBEE_API_KEY=${TEXTBEE_API_KEY:-}
      - TEXTBEE_API_URL=${TEXTBEE_API_URL:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
      - MAILCHANNELS_API_KEY=${MAILCHANNELS_API_KEY:-}
      - DKIM_DOMAIN=${DKIM_DOMAIN:-}
      - DKIM_SELECTOR=${DKIM_SELECTOR:-}
      - DKIM_PRIVATE_KEY=${DKIM_PRIVATE_KEY:-}
      # AI Bot
      - LLM_API_KEY=${LLM_API_KEY:-}
      # Agent Bot webhook URL
      - API_PUBLIC_URL=${API_PUBLIC_URL:-https://api.decent-cloud.org}
    volumes:
      - ../data/api-data-prod:/data
    networks:
      - decent-cloud-prod

  website:
    build:
      context: ..
      dockerfile: cf/Dockerfile
    image: decent-cloud-website:prod
    container_name: decent-cloud-prod-website
    restart: unless-stopped
    environment:
      - ENVIRONMENT=prod
    ports:
      - "59100:59010"
    networks:
      - decent-cloud-prod

  api-serve:
    build:
      context: ..
      dockerfile: api/Dockerfile
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        BINARY_HASH: ${BINARY_HASH:-unknown}
    image: decent-cloud-api:prod
    container_name: decent-cloud-prod-api-serve
    restart: unless-stopped
    depends_on:
      chatwoot-web:
        condition: service_healthy
    command: ["api-server", "serve"]
    environment:
      - ENVIRONMENT=prod
      - CANISTER_ID=${CANISTER_ID:-ggi4a-wyaaa-aaaai-actqq-cai}
      - RUST_LOG=${RUST_LOG:-info}
      - API_SERVER_PORT=59001
      - DATABASE_URL=sqlite:/data/ledger.db?mode=rwc
      - LEDGER_DIR=/data/ledger
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET}
      - GOOGLE_OAUTH_REDIRECT_URL=${GOOGLE_OAUTH_REDIRECT_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # ICPay integration (crypto payments)
      - ICPAY_SECRET_KEY=${ICPAY_SECRET_KEY}
      - MAILCHANNELS_API_KEY=${MAILCHANNELS_API_KEY}
      - DKIM_DOMAIN=${DKIM_DOMAIN}
      - DKIM_SELECTOR=${DKIM_SELECTOR}
      - DKIM_PRIVATE_KEY=${DKIM_PRIVATE_KEY}
      # Chatwoot integration
      - CHATWOOT_BASE_URL=http://chatwoot-web:59102
      - CHATWOOT_FRONTEND_URL=${CHATWOOT_FRONTEND_URL:-https://support.decent-cloud.org}
      - CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
      - CHATWOOT_PLATFORM_API_TOKEN=${CHATWOOT_PLATFORM_API_TOKEN}
      - CHATWOOT_ACCOUNT_ID=${CHATWOOT_ACCOUNT_ID:-1}
      - CHATWOOT_HMAC_SECRET=${CHATWOOT_HMAC_SECRET}
      - CHATWOOT_INBOX_ID=${CHATWOOT_INBOX_ID:-1}
      # Notifications
      - DEFAULT_ESCALATION_USER=${DEFAULT_ESCALATION_USER:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_BOT_USERNAME=${TELEGRAM_BOT_USERNAME:-DecentCloudBot}
      - TEXTBEE_DEVICE_ID=${TEXTBEE_DEVICE_ID:-}
      - TEXTBEE_API_KEY=${TEXTBEE_API_KEY:-}
      - TEXTBEE_API_URL=${TEXTBEE_API_URL:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
      # AI Bot configuration
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LLM_API_URL=${LLM_API_URL:-}
      - LLM_API_MODEL=${LLM_API_MODEL:-}
      # Agent Bot auto-registration (public URL for Chatwoot callbacks)
      - API_PUBLIC_URL=${API_PUBLIC_URL:-https://api.decent-cloud.org}
    volumes:
      - ../data/api-data-prod:/data
    ports:
      - "59101:59001"
    networks:
      - decent-cloud-prod
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:59001/api/v1/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  api-sync:
    build:
      context: ..
      dockerfile: api/Dockerfile
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        BINARY_HASH: ${BINARY_HASH:-unknown}
    image: decent-cloud-api:prod
    container_name: decent-cloud-prod-api-sync
    restart: unless-stopped
    command: ["api-server", "sync"]
    environment:
      - ENVIRONMENT=prod
      - CANISTER_ID=${CANISTER_ID:-ggi4a-wyaaa-aaaai-actqq-cai}
      - RUST_LOG=${RUST_LOG:-info}
      - API_SERVER_PORT=59001
      - SYNC_INTERVAL_SECS=${SYNC_INTERVAL_SECS:-30}
      - DATABASE_URL=sqlite:/data/ledger.db?mode=rwc
      - LEDGER_DIR=/data/ledger
    volumes:
      - ../data/api-data-prod:/data
    networks:
      - decent-cloud-prod

  validator:
    build:
      context: ..
      dockerfile: api/Dockerfile
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        BINARY_HASH: ${BINARY_HASH:-unknown}
    image: decent-cloud-api:prod
    container_name: decent-cloud-prod-validator
    restart: unless-stopped
    command: ["/usr/local/bin/validator-entrypoint.sh"]
    environment:
      - ENVIRONMENT=prod
      - NETWORK=${NETWORK:-ic}
      - VALIDATION_INTERVAL_SECS=${VALIDATION_INTERVAL_SECS:-600}
      - VALIDATION_MEMO=${VALIDATION_MEMO:-Automated periodic validation}
      - LOCAL_LEDGER_DIR=/data/ledger
      - IDENTITY_PATH=/identity
    volumes:
      - ../data/api-data-prod:/data
      - ${IDENTITY_LOCAL_PATH}:/identity:ro
    networks:
      - decent-cloud-prod
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/validator-healthy"]
      interval: 15m
      timeout: 10s
      start_period: 1m
      retries: 2

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: decent-cloud-prod-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN
    networks:
      - decent-cloud-prod
    depends_on:
      website:
        condition: service_healthy
      api-serve:
        condition: service_healthy
      chatwoot-web:
        condition: service_healthy

volumes:
  decent-cloud-prod-chatwoot-redis:

networks:
  decent-cloud-prod:
    driver: bridge

# Base configuration for Decent Cloud services
x-api-base: &api-base
  build:
    context: ..
    dockerfile: api/Dockerfile
    args:
      USER_ID: ${USER_ID:-1000}
      GROUP_ID: ${GROUP_ID:-1000}
      BINARY_HASH: ${BINARY_HASH:-unknown}
      BUILDKIT_INLINE_CACHE: 1
  image: decent-cloud-api:${ENVIRONMENT:-dev}
  restart: unless-stopped
  environment:
    - ENVIRONMENT=${ENVIRONMENT:-dev}
    - CANISTER_ID=${CANISTER_ID:-ggi4a-wyaaa-aaaai-actqq-cai}
    - RUST_LOG=${RUST_LOG:-info}
    - API_SERVER_PORT=59001
    - DATABASE_URL=sqlite:/data/ledger.db?mode=rwc
    - SYNC_INTERVAL_SECS=${SYNC_INTERVAL_SECS:-30} # Used for the sync service only
    - LEDGER_DIR=/data/ledger
    - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
    - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
    - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
    - MAILCHANNELS_API_KEY=${MAILCHANNELS_API_KEY}
    - DKIM_DOMAIN=${DKIM_DOMAIN}
    - DKIM_SELECTOR=${DKIM_SELECTOR}
    - DKIM_PRIVATE_KEY=${DKIM_PRIVATE_KEY}
  volumes:
    - ../data/api-data-prod:/data

services:
  website:
    build:
      context: ..
      dockerfile: cf/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: decent-cloud-website:${ENVIRONMENT:-dev}
    restart: unless-stopped
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-dev}
      # NOTE: VITE_* env vars must be set at BUILD time (before npm run build)
      # Not at runtime - they're baked into the static build

  api-serve:
    <<: *api-base
    command: ["api-server", "serve"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:59001/api/v1/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  api-sync:
    <<: *api-base
    command: ["api-server", "sync"]

  api-validate:
    <<: *api-base
    command: ["/usr/local/bin/validator-entrypoint.sh"]
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-dev}
      - NETWORK=${NETWORK:-ic}
      - VALIDATION_INTERVAL_SECS=${VALIDATION_INTERVAL_SECS:-600} # 10 minutes (block time)
      - VALIDATION_MEMO=${VALIDATION_MEMO:-Automated periodic validation}
      - LOCAL_LEDGER_DIR=/data/ledger
      - IDENTITY_PATH=/identity
    volumes:
      - ../data/api-data-prod:/data
      # REQUIRED: Mount your validator identity directory containing private.pem and public.pem
      # If your identity is at ~/.dcc/identity/my-identity, mount it as:
      # - ${HOME}/.dcc/identity/my-identity:/identity:ro
      - ${IDENTITY_LOCAL_PATH}:/identity:ro
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/validator-healthy"]
      interval: 15m
      timeout: 10s
      start_period: 1m
      retries: 2

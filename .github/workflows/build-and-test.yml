name: Rust

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}/ci-image@sha256:72d7a1ccdf2529d0b706f2bf9df1fae04e8e70fdae8eabc4bf7ad93016b03898

    steps:
      - uses: actions/checkout@v4
      - name: dfxvm init
        run: |
          echo "dfxvm requires the default version to be set once after starting the container (bug!)"
          dfxvm default 0.28.0
          dfx --version
      - name: Build and test
        env:
          # dfx requires XDG_DATA_HOME to be set
          XDG_DATA_HOME: /usr/local
        run: /tini -s -- cargo make

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: website/package-lock.json

      - name: Install website dependencies
        working-directory: ./website
        run: npm ci

      - name: Run website tests
        working-directory: ./website
        run: npm test

      - name: Install Cloudflare Next-on-Pages
        working-directory: ./website
        run: npm install -D @cloudflare/next-on-pages

      - name: Install WASM dependencies
        working-directory: ./wasm
        run: npm ci

      - name: Build WASM package
        working-directory: ./wasm
        run: npm run build

      - name: Build Next.js app for Cloudflare Pages
        working-directory: ./website
        run: npx @cloudflare/next-on-pages

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: |
            pages project list
            pages deploy .vercel/output/static --project-name=decent-cloud-website

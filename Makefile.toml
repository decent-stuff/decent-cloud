[env]
RUST_BACKTRACE = "1"
SQLX_OFFLINE = "true"

[config]
default_to_workspace = false
init_task = "postgres-start"
end_task = "cleanup"
on_error_task = "cleanup"
unstable_features = ["CTRL_C_HANDLING"]

[tasks.postgres-start]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

echo "Starting postgres..."
if ! output=$(docker compose up -d postgres 2>&1); then
    if echo "$output" | grep -q "port is already allocated"; then
        echo "✗ Port 5432 is already in use"
        echo "Check running containers: docker ps"
        echo "Stop other postgres containers or change the port mapping"
        exit 1
    fi
    echo "✗ Failed to start postgres"
    echo "$output"
    exit 1
fi

scripts/docker-compose-health.sh postgres 30
'''

[tasks.dfx-start]
dependencies = ["postgres-start"]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

cd ic-canister
for i in {1..10}; do dfx stop && break; sleep 1; pkill -9 -f versions || true; done;
dfx start --background --clean
while true; do
    dfx ping local && break;
    sleep 1;
done;
dfx canister create --all
'''

[tasks.format]
dependencies = ["dfx-start"]
install_crate = "rustfmt"
command = "cargo"
args = ["fmt", "--", "--emit=files"]

[tasks.canister]
dependencies = ["dfx-start"]
command = "dfx"
args = ["build", "--all"]
cwd = "./ic-canister/"

[tasks.clippy]
dependencies = ["sqlx-prepare", "dfx-start"]
command = "cargo"
args = ["clippy", "--tests"]

[tasks.clippy-canister]
dependencies = ["dfx-start"]
command = "cargo"
args = ["clippy", "--target=wasm32-unknown-unknown"]
cwd = "./ic-canister/"

[tasks.build]
dependencies = ["sqlx-prepare", "dfx-start"]
command = "cargo"
args = ["build"]

[tasks.setup-python]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

python3 scripts/setup-python-env.py
'''

[tasks.install-pocket-ic]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

python3 scripts/install-pocket-ic.py
'''

[tasks.build-whitepaper]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

if [ ! -d ".venv" ]; then
    echo "Virtual environment not found. Running setup first..."
    python3 scripts/setup-python-env.py
fi

source .venv/bin/activate
python3 ./docs/whitepaper/build.py
'''


[tasks.test]
dependencies = ["sqlx-prepare", "dfx-start", "build", "canister"]
command = "cargo"
args = ["nextest", "run"]

[tasks.dfx-stop]
script = '''
#!/usr/bin/env bash
set -eExuo pipefail

( cd ./ic-canister && for i in {1..10}; do dfx stop && break; sleep 1; pkill -9 -f versions || true; done; )
'''

[tasks.postgres-stop]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

echo "Stopping postgres..."
docker compose down
'''

[tasks.sqlx-prepare]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

unset SQLX_OFFLINE
TMPDB=$(mktemp --suffix=.db)
trap "rm -f $TMPDB" EXIT
DATABASE_URL="sqlite:$TMPDB?mode=rwc" sqlx database create
DATABASE_URL="sqlite:$TMPDB" sqlx migrate run --source api/migrations
DATABASE_URL="sqlite:$TMPDB" cargo sqlx prepare --workspace -- --tests
'''

[tasks.website-check]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

cd website
OUTPUT=$(npm run check 2>&1)
RESULT=$?
if [ $RESULT -ne 0 ]; then
    echo "$OUTPUT"
    exit $RESULT
fi
'''

[tasks.website-build]
dependencies = ["website-check"]
script = '''
#!/usr/bin/env bash
set -eEuo pipefail

cd website
OUTPUT=$(npm run build 2>&1)
RESULT=$?
if [ $RESULT -ne 0 ]; then
    echo "$OUTPUT"
    exit $RESULT
fi
'''

[tasks.all]
dependencies = [
    "format",
    "dfx-start",
    "canister",
    "clippy",
    "clippy-canister",
    "build",
    "test",
    "website-check",
    "website-build",
    "dfx-stop",
]

[tasks.cleanup]
dependencies = ["dfx-stop", "postgres-stop"]
